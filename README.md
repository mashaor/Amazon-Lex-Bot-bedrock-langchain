# Amazon Lex Chatbot powered by AI agents with Amazon Bedrock, Amazon Kendra, and LangChain


## Content
- [Overview](#overview)
- [Solution Architecture](#solution-architecture)
- [Agent Architecture](#agent-architecture)
- [Deployment Guide](#deployment-guide)
- [Post-Deployment](#post-deployment)

## Overview
This is a Company chatbot that is capable of producing human-like responses and engaging in natural language conversations by orchestrating a chain of calls to foundation models (FMs) and other augmenting tools based on user input. Instead of only fulfilling pre-defined intents through a static decision tree, agents are autonomous within the context of their suite of available tools. [Amazon Bedrock](https://aws.amazon.com/bedrock/) is a fully managed service that makes leading foundation models from AI companies available through an API along with developer tooling to help build and scale generative AI applications.

This solution creates a generative AI agent powered by Amazon Bedrock. The agent can assist users with finding answers to FAQ based on the company's website.

[Amazon Lex](https://docs.aws.amazon.com/lexv2/latest/dg/what-is.html) supplies the natural language understanding (NLU) and natural language processing (NLP) interface for the open source [LangChain conversational agent](https://python.langchain.com/docs/modules/agents/agent_types/chat_conversation_agent). The agent is equipped with tools that include an Anthropic Claude 3 Sonnet FM hosted on [Amazon Bedrock](https://aws.amazon.com/bedrock/) and [Amazon Kendra Index](https://docs.aws.amazon.com/kendra/latest/dg/what-is-kendra.html) that contains the data thas has been craweld from the client's website.

## Solution Architecture

1. Users perform natural dialog with the Agent. Each user request is processed by Lex which invokes an [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html) handler for intent fulfillment. Each user request is processed by Lex to determine user intent through a process called intent recognition, which involves analyzing and interpreting the user's input (text or speech) to understand the user's intended action or purpose.

2.	Lex then invokes an [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html) handler for user intent fulfillment. The Lambda function associated with the Lex chatbot contains the logic and business rules required to process the user's intent. Lambda performs specific actions or retrieves information based on the user's input, making decisions and generating appropriate responses.

3.	Lambda instruments a LangChain Conversational Agent that curates opinionated responses using webpages indexed by Kendra, and provide answers through the FM on Bedrock.

  	Responses generated by Kendra will include source attribution, demonstrating how you can provide additional contextual information to the agent through [Retrieval-Augmented Generation](https://aws.amazon.com/what-is/retrieval-augmented-generation/) (RAG). RAG allows you to enhance your agentâ€™s ability to generate more accurate and contextually relevant responses using your own data.

## Agent Architecture

1. The LangChain Conversational Agent uses memory to respond contextually to multiple queries. It remembers previous interactions, enabling it to provide relevant and appropriate answers throughout the conversation.


2. The agent uses Anthropic Claude 3 Sonnet on Amazon Bedrock to complete tasks through a series of carefully crafted text inputs known as prompts. The primary objective of prompt engineering is to elicit specific and accurate responses from the FM. This also includes limiting the agent to only specific answers related to the company, avoiding any other creative content, assuming identities, or receiving instructions from the user.

3. Using Kendra, the agent can perform a semantic similarity search across a wide range of content types. In our case, this will be done only on the information provided by the website.  

   More information on Kendra can be found here - [Kendra supported Data Sources](https://docs.aws.amazon.com/kendra/latest/dg/hiw-data-source.html).

## Deployment Guide

### Pre-Deployment
By default, AWS CloudFormation uses a temporary session that it generates from your user credentials for stack operations. If you specify a service role, CloudFormation will instead use that role's credentials.

To deploy this solution, your IAM user/role or service role must have permissions to deploy the resources specified in the CloudFormation template. For more details on AWS Identity and Access Management (IAM) with CloudFormation, please refer to the [AWS CloudFormation User Guide](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-template.html).

You must also have [AWS CLI](https://aws.amazon.com/cli/) installed. For instructions on installing AWS CLI, please see [Installing, updating, and uninstalling the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html).

1. Obtain the access keys for the IAM identity account that will be used for deployment.

   a. Paste the credentials in your AWS credentials file (~/.aws/credentials). It should look like this:

   ```
      [1234567890_AWSAdministrator]
      aws_access_key_id = ASIUQJ.....
      aws_secret_access_key = WtnHd.....
      aws_session_token = IQoJpZluX2.....
   ```
   b. Update the $AWS_PROFILE variable with the profile name (`1234567890_AWSAdministrator`) in the [create-stack.ps1](shell/create-stack.ps1) file. 

2. Enable Bedrock service with access to Anthropic Claude 3 Sonnet model


### Deployment 
The solution deployment automation script allows for automated solution provisioning through parameterized CloudFormation templates:

1. [GenAI-FSI-Agent.yml](cfn/GenAI-FSI-Agent.yml): for Lex bot which includes the following resources:

- An Amazon Lex bot configured through a bot import deployment package.
 - An S3 bucket that contains the Lambda agent handler, and Amazon Lex deployment packages.
 - Lambda function:
	- Agent handler - Contains the LangChain conversational agent logic that can intelligently employ a variety of tools based on user input.
 - A Lambda layer for Amazon Bedrock Boto3, LangChain, and pdfrw libraries, built from [requirements.txt](../agent/lambda-layers/requirements.txt). The layer supplies LangChain's FM library with an Amazon Bedrock model as the underlying FM and provides pdfrw as an open source PDF library for creating and modifying PDF files.
 - An Amazon Kendra Index: Provides a searchable index of customer authoritative information, including documents, FAQs, knowledge repositories, manuals, websites, and more.
 - One Kendra Data Source:
	- Amazon Kendra Web Crawler - Configured with a root domain that emulates the customer-specific website (for example, _<your-company>.com_).
 - [AWS Identity and Access Management](https://aws.amazon.com/iam/) (IAM) permissions for the preceding resources.

2. [Lex-UI.yaml](cfn/Lex-UI.yaml): for Lex bot UI, which includes the following resources:

- An Amazon Lex bot UI CloudFormation stack:
 - Cognito Identity Pool used to pass temporary AWS credentials to the web app. You can optionally pass the ID of an existing Cognito Identity Pool to avoid creating a new one.
 - S3 buckets to host the web application and to store build artifacts.
 - Lambda functions used as CloudFormation Custom Resources to facilitate custom provisioning logic
 - CloudWatch Logs groups automatically created to log the output of the Lambda functions
 - Associated IAM roles for the stack resources

AWS CloudFormation prepopulates stack parameters with the default values provided in the template. To provide alternative input values, you can specify parameters as environment variables that are referenced in the _`ParameterKey=<ParameterKey>,ParameterValue=<Value>`_ pairs in the below shell script's _`aws cloudformation create-stack`_ command. 

The parameters for the UI CloudFormation template ([create-stack.ps1](shell\create-stack.ps1)) include configuration settings such as the initial text that will appear in the bot, the toolbar title, and the color theme. These settings can be adjusted during the initial deployment or modified afterward by updating the CSS and/or json configuration (See [Customization of the UI](#Customization-of-the-UI)). 

 ```
    "ParameterKey=WebAppConfToolbarTitle,ParameterValue='FAQ'" `
    "ParameterKey=WebAppConfBotInitialText,ParameterValue='How can I help?'" `
    "ParameterKey=ToolbarColor,ParameterValue='#757575'" `
    "ParameterKey=ChatBackgroundColor,ParameterValue='#FFFFFF'" `
    "ParameterKey=BotChatBubble,ParameterValue='#ECEFF1'" `
    "ParameterKey=CustomerChatBubble,ParameterValue='#80CBC4'" `
 ```

### Run Deployment Automation Script

Run the Powershell script to deploy the solution's resources:

```sh
>./create-stack.ps1
```

### Post-Deployment

In this section, we discuss the post-deployment steps for launching a front-end application that is intended to emulate the Production application. 

### Launch a Web UI for Your Chatbot

To access your chat's full-page website, navigate to the WebUI CloudFormation (with "lex-UI" in the name) stack's [Outputs tab](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-console-view-stack-data-resources.html) tab and locate the WebAppUrl link. Alternatively, use the following command:

```
aws cloudformation describe-stacks \
    --stack-name $STACK_NAME \
    --query 'Stacks[0].Outputs[?OutputKey==`WebAppUrl`].OutputValue' --output text
```

Once the chatbot UI is open, proceed to test it with user messages.

### Embeding chat in to website

After AWS CloudFormation launches the stack (the status is `CREATE_COMPLETE`), you will see a link in the Outputs tab in the `SnippetUrl` output value. To access your chat's iFrame snippet code, navigate to the WebUI CloudFormation (with "lex-UI" in the name) stack's Outputs tab and locate the `SnippetUrl` link. You will see a code snippet that you can paste into your application.

Please note that once the snippet is embedded, it can only be accessed from the website domain that it was configured with during the creation of the CloudFormation stack. The website domain is configured in [create-stack.ps1](shell\create-stack.ps1) file, `$UI_TEMPLATE_PATH` parameter.

For more information, refer to the [Chat UI Documentation.](https://aws.amazon.com/blogs/machine-learning/deploy-a-web-ui-for-your-chatbot/) 

### Customization of the UI

The look and feel of the chat can be customized using CSS. For more details, see the [CSS modification guide](https://github.com/aws-samples/aws-lex-web-ui/blob/master/README-css-style.md)

To change some of the initial settings of the bot, such as the toolbar title or initial text, edit the lex-web-ui-loader-config.json file located in the S3 bucket where it is deployed. The name of the S3 bucket is should be 'lex-web-ui-codebuilddeploy-XXXXXXXXX-webappbucket-XXXXXXXXXXXX'. For more details, see the [updaing json configuration](https://catalog.us-east-1.prod.workshops.aws/workshops/94f60d43-15b7-45f4-bbbc-17889ae64ea0/en-US/lexwebui/embedding#update-json-file)

### Sources

Based on the example [Source](https://github.com/aws-samples/generative-ai-amazon-bedrock-langchain-agent-example)